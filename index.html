import React, { useState, useEffect, useRef } from 'react';
import { Plus, Search, Filter, Calendar, Bell, Tag, Star, Trash2, Edit3, ChevronDown, ChevronRight, Sun, Moon, BarChart3 } from 'lucide-react';

const TodoApp = () => {
  // 상태 관리
  const [tasks, setTasks] = useState([]);
  const [newTask, setNewTask] = useState('');
  const [filter, setFilter] = useState('all');
  const [sortBy, setSortBy] = useState('created');
  const [searchTerm, setSearchTerm] = useState('');
  const [showStats, setShowStats] = useState(false);
  const [darkMode, setDarkMode] = useState(false);
  const [editingTask, setEditingTask] = useState(null);
  const [selectedTags, setSelectedTags] = useState([]);
  const [showAddForm, setShowAddForm] = useState(false);
  
  // 새 할 일 폼 상태
  const [taskForm, setTaskForm] = useState({
    title: '',
    note: '',
    priority: 'medium',
    dueDate: '',
    tags: [],
    reminder: '',
    repeat: 'none'
  });

  const inputRef = useRef(null);

  // 로컬 스토리지에서 데이터 로드
  useEffect(() => {
    const savedTasks = localStorage.getItem('todoTasks');
    const savedTheme = localStorage.getItem('todoTheme');
    const savedFilter = localStorage.getItem('todoFilter');
    
    if (savedTasks) {
      setTasks(JSON.parse(savedTasks));
    }
    if (savedTheme) {
      setDarkMode(savedTheme === 'dark');
    }
    if (savedFilter) {
      setFilter(savedFilter);
    }
  }, []);

  // 데이터 저장
  useEffect(() => {
    localStorage.setItem('todoTasks', JSON.stringify(tasks));
  }, [tasks]);

  useEffect(() => {
    localStorage.setItem('todoTheme', darkMode ? 'dark' : 'light');
  }, [darkMode]);

  useEffect(() => {
    localStorage.setItem('todoFilter', filter);
  }, [filter]);

  // 고유 ID 생성
  const generateId = () => `task-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

  // 할 일 추가
  const addTask = () => {
    if (!taskForm.title.trim()) return;

    const newTaskItem = {
      id: generateId(),
      title: taskForm.title.trim(),
      note: taskForm.note.trim(),
      completed: false,
      priority: taskForm.priority,
      dueDate: taskForm.dueDate || null,
      createdAt: new Date().toISOString(),
      updatedAt: null,
      repeat: taskForm.repeat,
      tags: taskForm.tags,
      reminder: taskForm.reminder || null,
      subtasks: []
    };

    setTasks(prev => [newTaskItem, ...prev]);
    setTaskForm({
      title: '',
      note: '',
      priority: 'medium',
      dueDate: '',
      tags: [],
      reminder: '',
      repeat: 'none'
    });
    setShowAddForm(false);
  };

  // 할 일 완료 토글
  const toggleTask = (id) => {
    setTasks(prev => prev.map(task => 
      task.id === id 
        ? { ...task, completed: !task.completed, updatedAt: new Date().toISOString() }
        : task
    ));
  };

  // 할 일 삭제
  const deleteTask = (id) => {
    setTasks(prev => prev.filter(task => task.id !== id));
  };

  // 서브태스크 추가
  const addSubtask = (taskId, subtaskText) => {
    if (!subtaskText.trim()) return;
    
    setTasks(prev => prev.map(task => 
      task.id === taskId 
        ? {
            ...task, 
            subtasks: [...task.subtasks, {
              id: generateId(),
              text: subtaskText.trim(),
              completed: false
            }]
          }
        : task
    ));
  };

  // 서브태스크 토글
  const toggleSubtask = (taskId, subtaskId) => {
    setTasks(prev => prev.map(task => 
      task.id === taskId 
        ? {
            ...task,
            subtasks: task.subtasks.map(subtask =>
              subtask.id === subtaskId 
                ? { ...subtask, completed: !subtask.completed }
                : subtask
            )
          }
        : task
    ));
  };

  // 태그 추가
  const addTag = (taskId, tag) => {
    if (!tag.trim()) return;
    
    setTasks(prev => prev.map(task => 
      task.id === taskId 
        ? { ...task, tags: [...new Set([...task.tags, tag.trim()])] }
        : task
    ));
  };

  // 모든 태그 가져오기
  const getAllTags = () => {
    const allTags = tasks.flatMap(task => task.tags);
    return [...new Set(allTags)];
  };

  // 우선순위 색상
  const getPriorityColor = (priority) => {
    switch (priority) {
      case 'high': return 'text-red-500 border-red-200';
      case 'medium': return 'text-yellow-500 border-yellow-200';
      case 'low': return 'text-green-500 border-green-200';
      default: return 'text-gray-500 border-gray-200';
    }
  };

  // 마감일 상태 확인
  const getDueDateStatus = (dueDate) => {
    if (!dueDate) return null;
    
    const now = new Date();
    const due = new Date(dueDate);
    const diffHours = (due - now) / (1000 * 60 * 60);
    
    if (diffHours < 0) return 'overdue';
    if (diffHours < 24) return 'due-soon';
    return 'normal';
  };

  // 필터링된 할 일 목록
  const filteredTasks = tasks.filter(task => {
    // 완료 상태 필터
    if (filter === 'completed' && !task.completed) return false;
    if (filter === 'pending' && task.completed) return false;
    
    // 검색어 필터
    if (searchTerm && !task.title.toLowerCase().includes(searchTerm.toLowerCase())) return false;
    
    // 태그 필터
    if (selectedTags.length > 0 && !selectedTags.every(tag => task.tags.includes(tag))) return false;
    
    return true;
  });

  // 정렬된 할 일 목록
  const sortedTasks = [...filteredTasks].sort((a, b) => {
    switch (sortBy) {
      case 'priority':
        const priorityOrder = { high: 3, medium: 2, low: 1 };
        return priorityOrder[b.priority] - priorityOrder[a.priority];
      case 'dueDate':
        if (!a.dueDate && !b.dueDate) return 0;
        if (!a.dueDate) return 1;
        if (!b.dueDate) return -1;
        return new Date(a.dueDate) - new Date(b.dueDate);
      case 'created':
      default:
        return new Date(b.createdAt) - new Date(a.createdAt);
    }
  });

  // 통계 계산
  const stats = {
    total: tasks.length,
    completed: tasks.filter(t => t.completed).length,
    pending: tasks.filter(t => !t.completed).length,
    overdue: tasks.filter(t => getDueDateStatus(t.dueDate) === 'overdue').length,
    highPriority: tasks.filter(t => t.priority === 'high' && !t.completed).length
  };

  return (
    <div className={`min-h-screen transition-colors duration-300 ${
      darkMode 
        ? 'bg-gray-900 text-white' 
        : 'bg-gradient-to-br from-blue-50 via-white to-purple-50 text-gray-900'
    }`}>
      <div className="container mx-auto px-4 py-8 max-w-4xl">
        {/* 헤더 */}
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
              할 일 관리
            </h1>
            <p className="text-gray-600 dark:text-gray-400 mt-2">
              효율적인 업무 관리로 더 나은 하루를 만들어보세요
            </p>
          </div>
          
          <div className="flex items-center gap-3">
            <button
              onClick={() => setShowStats(!showStats)}
              className={`p-3 rounded-xl transition-all ${
                darkMode 
                  ? 'bg-gray-800 hover:bg-gray-700' 
                  : 'bg-white hover:bg-gray-50 shadow-md'
              }`}
            >
              <BarChart3 size={20} />
            </button>
            
            <button
              onClick={() => setDarkMode(!darkMode)}
              className={`p-3 rounded-xl transition-all ${
                darkMode 
                  ? 'bg-gray-800 hover:bg-gray-700' 
                  : 'bg-white hover:bg-gray-50 shadow-md'
              }`}
            >
              {darkMode ? <Sun size={20} /> : <Moon size={20} />}
            </button>
          </div>
        </div>

        {/* 통계 */}
        {showStats && (
          <div className={`grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 p-4 rounded-2xl ${
            darkMode ? 'bg-gray-800' : 'bg-white shadow-lg'
          }`}>
            <div className="text-center">
              <div className="text-2xl font-bold text-blue-600">{stats.total}</div>
              <div className="text-sm text-gray-500">전체</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-green-600">{stats.completed}</div>
              <div className="text-sm text-gray-500">완료</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-yellow-600">{stats.pending}</div>
              <div className="text-sm text-gray-500">진행중</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-red-600">{stats.overdue}</div>
              <div className="text-sm text-gray-500">지연</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-purple-600">{stats.highPriority}</div>
              <div className="text-sm text-gray-500">중요</div>
            </div>
          </div>
        )}

        {/* 새 할 일 추가 */}
        <div className={`mb-6 p-6 rounded-2xl ${
          darkMode ? 'bg-gray-800' : 'bg-white shadow-lg'
        }`}>
          {!showAddForm ? (
            <button
              onClick={() => setShowAddForm(true)}
              className="w-full p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl hover:border-blue-400 transition-colors flex items-center justify-center gap-2 text-gray-500 hover:text-blue-500"
            >
              <Plus size={20} />
              새로운 할 일 추가하기
            </button>
          ) : (
            <div className="space-y-4">
              <input
                ref={inputRef}
                type="text"
                placeholder="할 일을 입력하세요..."
                value={taskForm.title}
                onChange={(e) => setTaskForm(prev => ({ ...prev, title: e.target.value }))}
                className={`w-full p-3 rounded-xl border ${
                  darkMode 
                    ? 'bg-gray-700 border-gray-600 focus:border-blue-400' 
                    : 'bg-gray-50 border-gray-200 focus:border-blue-400'
                } focus:outline-none focus:ring-2 focus:ring-blue-100`}
                onKeyPress={(e) => e.key === 'Enter' && addTask()}
                autoFocus
              />
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <textarea
                  placeholder="상세 설명 (선택사항)"
                  value={taskForm.note}
                  onChange={(e) => setTaskForm(prev => ({ ...prev, note: e.target.value }))}
                  className={`p-3 rounded-xl border resize-none ${
                    darkMode 
                      ? 'bg-gray-700 border-gray-600 focus:border-blue-400' 
                      : 'bg-gray-50 border-gray-200 focus:border-blue-400'
                  } focus:outline-none focus:ring-2 focus:ring-blue-100`}
                  rows="2"
                />
                
                <div className="space-y-3">
                  <select
                    value={taskForm.priority}
                    onChange={(e) => setTaskForm(prev => ({ ...prev, priority: e.target.value }))}
                    className={`w-full p-3 rounded-xl border ${
                      darkMode 
                        ? 'bg-gray-700 border-gray-600' 
                        : 'bg-gray-50 border-gray-200'
                    } focus:outline-none`}
                  >
                    <option value="low">낮은 우선순위</option>
                    <option value="medium">보통 우선순위</option>
                    <option value="high">높은 우선순위</option>
                  </select>
                  
                  <input
                    type="datetime-local"
                    value={taskForm.dueDate}
                    onChange={(e) => setTaskForm(prev => ({ ...prev, dueDate: e.target.value }))}
                    className={`w-full p-3 rounded-xl border ${
                      darkMode 
                        ? 'bg-gray-700 border-gray-600' 
                        : 'bg-gray-50 border-gray-200'
                    } focus:outline-none`}
                  />
                </div>
              </div>
              
              <div className="flex gap-2 pt-2">
                <button
                  onClick={addTask}
                  disabled={!taskForm.title.trim()}
                  className="px-6 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
                >
                  <Plus size={16} />
                  추가
                </button>
                <button
                  onClick={() => {
                    setShowAddForm(false);
                    setTaskForm({
                      title: '',
                      note: '',
                      priority: 'medium',
                      dueDate: '',
                      tags: [],
                      reminder: '',
                      repeat: 'none'
                    });
                  }}
                  className={`px-6 py-2 rounded-xl transition-colors ${
                    darkMode 
                      ? 'bg-gray-700 hover:bg-gray-600' 
                      : 'bg-gray-200 hover:bg-gray-300'
                  }`}
                >
                  취소
                </button>
              </div>
            </div>
          )}
        </div>

        {/* 필터 및 검색 */}
        <div className={`mb-6 p-4 rounded-2xl ${
          darkMode ? 'bg-gray-800' : 'bg-white shadow-lg'
        }`}>
          <div className="flex flex-wrap gap-4 items-center">
            <div className="flex-1 min-w-64">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={16} />
                <input
                  type="text"
                  placeholder="할 일 검색..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className={`w-full pl-10 pr-4 py-2 rounded-xl border ${
                    darkMode 
                      ? 'bg-gray-700 border-gray-600' 
                      : 'bg-gray-50 border-gray-200'
                  } focus:outline-none focus:ring-2 focus:ring-blue-100`}
                />
              </div>
            </div>
            
            <select
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
              className={`px-4 py-2 rounded-xl border ${
                darkMode 
                  ? 'bg-gray-700 border-gray-600' 
                  : 'bg-gray-50 border-gray-200'
              } focus:outline-none`}
            >
              <option value="all">전체 보기</option>
              <option value="pending">미완료만</option>
              <option value="completed">완료만</option>
            </select>
            
            <select
              value={sortBy}
              onChange={(e) => setSortBy(e.target.value)}
              className={`px-4 py-2 rounded-xl border ${
                darkMode 
                  ? 'bg-gray-700 border-gray-600' 
                  : 'bg-gray-50 border-gray-200'
              } focus:outline-none`}
            >
              <option value="created">생성일순</option>
              <option value="priority">우선순위순</option>
              <option value="dueDate">마감일순</option>
            </select>
          </div>
          
          {/* 태그 필터 */}
          {getAllTags().length > 0 && (
            <div className="mt-4">
              <div className="flex flex-wrap gap-2">
                {getAllTags().map(tag => (
                  <button
                    key={tag}
                    onClick={() => {
                      setSelectedTags(prev => 
                        prev.includes(tag) 
                          ? prev.filter(t => t !== tag)
                          : [...prev, tag]
                      );
                    }}
                    className={`px-3 py-1 rounded-full text-sm transition-colors ${
                      selectedTags.includes(tag)
                        ? 'bg-blue-600 text-white'
                        : darkMode 
                          ? 'bg-gray-700 hover:bg-gray-600' 
                          : 'bg-gray-200 hover:bg-gray-300'
                    }`}
                  >
                    #{tag}
                  </button>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* 할 일 목록 */}
        <div className="space-y-3">
          {sortedTasks.length === 0 ? (
            <div className={`text-center py-12 ${
              darkMode ? 'text-gray-400' : 'text-gray-500'
            }`}>
              <div className="text-6xl mb-4">📝</div>
              <p className="text-lg">
                {tasks.length === 0 
                  ? '아직 할 일이 없습니다. 새로운 할 일을 추가해보세요!' 
                  : '검색 조건에 맞는 할 일이 없습니다.'}
              </p>
            </div>
          ) : (
            sortedTasks.map(task => (
              <TaskItem
                key={task.id}
                task={task}
                onToggle={toggleTask}
                onDelete={deleteTask}
                onAddSubtask={addSubtask}
                onToggleSubtask={toggleSubtask}
                onAddTag={addTag}
                darkMode={darkMode}
                getPriorityColor={getPriorityColor}
                getDueDateStatus={getDueDateStatus}
              />
            ))
          )}
        </div>
      </div>
    </div>
  );
};

// 개별 할 일 컴포넌트
const TaskItem = ({ 
  task, 
  onToggle, 
  onDelete, 
  onAddSubtask, 
  onToggleSubtask, 
  onAddTag, 
  darkMode, 
  getPriorityColor, 
  getDueDateStatus 
}) => {
  const [expanded, setExpanded] = useState(false);
  const [newSubtask, setNewSubtask] = useState('');
  const [newTag, setNewTag] = useState('');

  const dueDateStatus = getDueDateStatus(task.dueDate);
  const completedSubtasks = task.subtasks.filter(st => st.completed).length;

  return (
    <div className={`p-4 rounded-2xl transition-all ${
      darkMode ? 'bg-gray-800' : 'bg-white shadow-lg'
    } ${task.completed ? 'opacity-60' : ''}`}>
      <div className="flex items-start gap-4">
        {/* 체크박스 */}
        <button
          onClick={() => onToggle(task.id)}
          className={`mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${
            task.completed 
              ? 'bg-green-500 border-green-500 text-white' 
              : `border-gray-300 hover:border-blue-400 ${getPriorityColor(task.priority)}`
          }`}
        >
          {task.completed && '✓'}
        </button>

        <div className="flex-1">
          {/* 제목과 우선순위 */}
          <div className="flex items-center gap-2 mb-2">
            <h3 className={`text-lg font-semibold ${
              task.completed ? 'line-through text-gray-500' : ''
            }`}>
              {task.title}
            </h3>
            
            <div className={`px-2 py-1 rounded-full text-xs border ${getPriorityColor(task.priority)}`}>
              {task.priority === 'high' ? '🔥 높음' : 
               task.priority === 'medium' ? '⭐ 보통' : '💤 낮음'}
            </div>

            {dueDateStatus === 'overdue' && (
              <span className="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs">
                지연됨
              </span>
            )}
            {dueDateStatus === 'due-soon' && (
              <span className="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs">
                임박
              </span>
            )}
          </div>

          {/* 메모 */}
          {task.note && (
            <p className={`text-sm mb-2 ${
              darkMode ? 'text-gray-300' : 'text-gray-600'
            }`}>
              {task.note}
            </p>
          )}

          {/* 마감일 */}
          {task.dueDate && (
            <div className="flex items-center gap-1 text-sm text-gray-500 mb-2">
              <Calendar size={14} />
              {new Date(task.dueDate).toLocaleString('ko-KR')}
            </div>
          )}

          {/* 태그 */}
          {task.tags.length > 0 && (
            <div className="flex flex-wrap gap-1 mb-2">
              {task.tags.map(tag => (
                <span
                  key={tag}
                  className={`px-2 py-1 rounded-full text-xs ${
                    darkMode 
                      ? 'bg-gray-700 text-gray-300' 
                      : 'bg-blue-100 text-blue-700'
                  }`}
                >
                  #{tag}
                </span>
              ))}
            </div>
          )}

          {/* 서브태스크 */}
          {task.subtasks.length > 0 && (
            <div className="mb-2">
              <div className="text-sm text-gray-500 mb-1">
                진행률: {completedSubtasks}/{task.subtasks.length}
              </div>
              <div className={`w-full h-2 rounded-full ${
                darkMode ? 'bg-gray-700' : 'bg-gray-200'
              }`}>
                <div
                  className="h-full bg-green-500 rounded-full transition-all"
                  style={{ width: `${(completedSubtasks / task.subtasks.length) * 100}%` }}
                />
              </div>
            </div>
          )}

          {/* 확장 가능한 영역 */}
          {expanded && (
            <div className="mt-4 space-y-3">
              {/* 서브태스크 목록 */}
              {task.subtasks.map(subtask => (
                <div key={subtask.id} className="flex items-center gap-2 ml-4">
                  <button
                    onClick={() => onToggleSubtask(task.id, subtask.id)}
                    className={`w-4 h-4 rounded border flex items-center justify-center text-xs ${
                      subtask.completed 
                        ? 'bg-green-500 border-green-500 text-white' 
                        : 'border-gray-300'
                    }`}
                  >
                    {subtask.completed && '✓'}
                  </button>
                  <span className={subtask.completed ? 'line-through text-gray-500' : ''}>
                    {subtask.text}
                  </span>
                </div>
              ))}

              {/* 새 서브태스크 추가 */}
              <div className="flex gap-2 ml-4">
                <input
                  type="text"
                  placeholder="서브 할 일 추가..."
                  value={newSubtask}
                  onChange={(e) => setNewSubtask(e.target.value)}
                  className={`flex-1 px-3 py-1 text-sm rounded border ${
                    darkMode 
                      ? 'bg-gray-700 border-gray-600' 
                      : 'bg-gray-50 border-gray-200'
                  } focus:outline-none`}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      onAddSubtask(task.id, newSubtask);
                      setNewSubtask('');
                    }
                  }}
                />
                <button
                  onClick={() => {
                    onAddSubtask(task.id, newSubtask);
                    setNewSubtask('');
                  }}
                  className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                >
                  추가
                </button>
              </div>

              {/* 새 태그 추가 */}
              <div className="flex gap-2">
                <input
                  type="text"
                  placeholder="태그 추가..."
                  value={newTag}
                  onChange={(e) => setNewTag(e.target.value)}
                  className={`flex-1 px-3 py-1 text-sm rounded border ${
                    darkMode 
                      ? 'bg-gray-700 border-gray-600' 
                      : 'bg-gray-50 border-gray-200'
                  } focus:outline-none`}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      onAddTag(task.id, newTag);
                      setNewTag('');
                    }
                  }}
                />
                <button
                  onClick={() => {
                    onAddTag(task.id, newTag);
                    setNewTag('');
                  }}
                  className="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700"
                >
                  태그
                </button>
              </div>
            </div>
          )}
        </div>

        {/* 액션 버튼 */}
        <div className="flex gap-2">
          <button
            onClick={() => setExpanded(!expanded)}
            className={`p-2 rounded-lg transition-colors ${
              darkMode 
                ? 'hover:bg-gray-700' 
                : 'hover:bg-gray-100'
            }`}
          >
            {expanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
          </button>
          
          <button
            onClick={() => onDelete(task.id)}
            className="p-2 rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
          >
            <Trash2 size={16} />
          </button>
        </div>
      </div>
    </div>
  );
};

export default TodoApp;
